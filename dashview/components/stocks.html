<!--removeIf(script)-->
<script type="text/javascript">
App.stocks= new Vue({
  template: '#template-stocks',
  data: {
    stockItems: [],
    failed: false
  },
  mounted: function() {
    this.backgroundUpdate();
    this.backgroundInterval = setInterval(function(){
      this.backgroundUpdate();
    }.bind(this),(1000*60)*10)

  },
  filters: {
    round: function (value) {
      if(value < 100 ) {
       return value; 
      } else {
        return Math.round(value);
      }
    }
  },
  methods: {

    backgroundUpdate: function() {
      $.ajax({
        type: 'GET',
       /* dataType:"xml",*/
        url:App.templateURL+'/webproxy.php?id=stocks',
        success: function(data){
        
          var newStocks = [];
          var numerator = 0;
          var stockItems = data.split("\r\n");
          stockItems.forEach(function(e,i){
            var stockArray = e.split(',');
            newStocks.push({
              title: stockArray[0],
              last:parseFloat(stockArray[1]),
              change:parseFloat(stockArray[2])
            });
            
          });
/*
          var table = $(data).find('item description').text().replace('<![CDATA[','').replace(']]>','');

          $('body').append('<div id="stock-parser" style="display:none;">'+table+'</div>');


          $('#stock-parser').find('table').each(function(){
            var item = {};
            var trs = $(this).find('tr');
            if(trs.length < 5) {
              return;
            }
            item.title = $(trs[0]).text().trim();
            item.last = parseFloat($(trs[1]).find('td').last().text()).toFixed(2);
            item.change = parseFloat($(trs[2]).find('td').last().text().trim());
            newStocks.push(item);


          })

          $('#stock-parser').remove();*/
          this.stockItems = newStocks;

        }.bind(this),
        error: function(data) {
          if(!this.failed) {
            this.failed = new Date();
          }
        }.bind(this)

      });

    }
  }
});
</script>
<!--endRemoveIf(script)-->
<div class="module stocks clearfix">
  <div class="stock" v-for="stock in stockItems">
    <div class="title">
      {{stock.title}}
    </div>
    <div class="last">
      ${{stock.last | round}}
    </div>
    <div class="change" v-if="!isNaN(stock.change)">
      <div class="arrow" :class="{rotate: stock.change < 0}">
        <?= file_get_contents(get_template_directory().'/assets/fonts/icon_arrow_up.svg');?>
      </div>
      {{stock.change}}
    </div>
    <div class="change" v-if="isNaN(stock.change) || stock.change === 0">
      &mdash;&mdash;
    </div>


  </div>
  <fail-pill :failed="this.failed"/>
</div>
