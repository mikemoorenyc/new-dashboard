<!--removeIf(script)-->
<script type="text/javascript">
App.calendar= new Vue({
  template: '#template-calendar',
  data: {
    today:[],
    tomorrow:[],
    backgroundInterval: null
  },
  mounted: function() {
    this.userLoop();
    this.backgroundInterval = setInterval(function(){
      this.userLoop();
    }.bind(this),(1000*60)*10)

  },
  methods: {
    userLoop:function() {
      App.allUsers.forEach(function(e,i){
        if(e.calendarReady) {
          this.backgroundUpdate(e);
        }
      }.bind(this))
    },
    backgroundUpdate: function(user) {
      $.ajax({
        type: 'GET',

        url:App.homeURL+'/google-calendar/?id='+user.id,
        success: function(data){

          var items = data.items;

          var newToday = this.today.filter(function(e){
            return e.user.id !== user.id;
          });
          var newTomorrow = this.tomorrow.filter(function(e){
            return e.user.id !== user.id;
          })
          var today = new Date().getDate();
          var tomorrow = new Date().getDate()+1;
          items.forEach(function(e,i) {
            var item = {
             date: new Date(e.date),
             title: e.title,
             user: user,
             formatted: hoursFormatter(new Date(e.date)),
             allDay: e.allDay
            }

            if(item.date.getDate() === today) {
              newToday.push(item);
            }
            if(item.date.getDate() === tomorrow) {
             newTomorrow.push(item);
            }
          }.bind(this));
          function dateSort(a, b) {
              a =a.date;
              b = b.date;
              return a<b ? -1 : a>b ? 1 : 0;
          };
          newToday.sort(dateSort);
          newTomorrow.sort(dateSort);
          this.today = newToday;
          this.tomorrow = newTomorrow;
        }.bind(this)

      });

    }
  }
});


</script>
<!--endRemoveIf(script)-->
<div class="module calendar">
  <div class="today">
    <div class="nothing-to-do" v-if="today.length < 1">
      <div class="icon">
        <?php echo file_get_contents(get_template_directory().'/assets/fonts/icon_couch.svg');?>
      </div>
      There's nothing going on today!
    </div>
    <div v-for="item in today" class="item">
      <div class="date">
        <div class="dot"  :style="{background:item.user.color}">
          <div  class="initial">{{item.user.firstname[0]}}</div>
        </div>
        <div v-if="!item.allDay">
          {{item.formatted.hours}}:{{item.formatted.minutes}}{{item.formatted.ampm}}
        </div>
        <div v-if="item.allDay">
          All Day
        </div>
      </div>
      <div class="title">
        {{item.title}}
      </div>
    </div>
  </div>
  <div class="tomorrow-container">
    <div class="nothing-tomorrow" v-if="tomorrow.length < 1" style="font-size:18rem;">
      All free tomorrow<span v-if="tomorrow.length<1 && today.length<1">, too</span>.
    </div>
    <div class="tomorrow-header" v-if="tomorrow.length>0">Tomorrow</div>
    <div v-for="item in tomorrow" class="item tomorrow">
      <div class="date tomorrow">
        <div class="dot tomorrow"  :style="{background:item.user.color}">
          <div style="display:none;" class="initial tomorrow">{{item.user.firstname[0]}}</div>
        </div>
        <div v-if="!item.allDay">
          {{item.formatted.hours}}:{{item.formatted.minutes}}{{item.formatted.ampm}}
        </div>
        <div v-if="item.allDay">
          All Day
        </div>
      </div>
      <div class="title tomorrow">
        {{item.title}}
      </div>
    </div>
  </div>
</div>
