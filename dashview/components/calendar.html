<!--removeIf(script)-->
<script type="text/javascript">
App.calendar = new Vue({
  template: '#template-calendar',
  data: {
    today: [],
    tomorrow: [],
		upcoming: [],
		users: [],
    backgroundInterval: null
  },
  mounted: function mounted() {
		App.allUsers.forEach(function(e) {
			if(e.calendarReady) {
				this.users.push(e);
				this.backgroundUpdate(e);
			}
		});
    this.backgroundInterval = setInterval(function () {
      this.users.forEach(function(e) {
				this.backgroundUpdate(e);
			});
    }.bind(this), 1000 * 60 * 10);
  },
  methods: {
		dateEval(date) {
			var date = new Date();
			date.setHours(0,0,0,0);
			var morning = date.getTime();
			date.setHours(23,59,59,999);
			var midnight = date.getTime();
			date.setDate(date.getDate()+1);
			var tomorrowEnd = date.getTime();
			switch(date) {
				case (date < morning):
					return "old";
					break;
				case (date <= midnight):
					return "today";
					break;
				case (date <= tomorrowEnd):
					return "tomorrow";
					break;
				case (date > tomorrowEnd):
					return "upcoming";
					break;
			} 
		},
    combiner(oldCal,newCal) {
      var newC = newCal.slice();
      var oldC = oldCal.slice();
      newC.forEach(function(e,i){
        var id =e.id;
        var user = e.user;
        //CHECK IF NEW
        var dupe = false;
        oldC.forEach(function(e,i){
          if(id === e.id) {
            var newItem = this.addUser(e, user);
            oldC[i] = newItem;
            var dupe = true;
            return false;
          }
        }.bind(this));
        if(!dupe) {
          var item = e;
          item.users = [item.user];
          oldC.push(e);
        }
      }.bind(this));
      return oldC;
    },
    addUser(item,user) {
      var users = item.user;
      var add = false;
      users.forEach(function(e,i){
        if(e.id === user.id) {
          add = true;
        }
      });
      if(add) {
        return item;
      }
      users.push(user);
      item.users = users;
      return item;
    },
		oldRemover(list) {
			return list.filter(function(item) {
				this.dateEval(item.date) !== "old";
			}.bind(this));
		},
		listCreator(newItem) {
			var date = new Date();
			var today = this.oldRemover(this.today.slice()),
					tomorrow = this.oldRemover(this.tomorrow.slice()),
					upcoming = this.oldRemover(this.upcoming.slice()),
					
			
		},
		sectionMerge(item,list,interval) {
			//Remove Old Ones and filter to correct interval
			var newUser = item.users[0];
			var nList = list.filter(function(e) {
				return this.dateEval(e.date) === interval;
			}.bind(this));
			// new item isn't within interval, return filtered list
			if(this.dateEval(item.date) !== interval) {
				return nList;
			}
			//ID Match
			var match = nList.filter(function(e) {
				return item.id === e.id;
			})[0];
			//IF no match, add item and return
			if(!match) {
				return nList.push(item);
			}
			//Remove newUser and add back in
			var newUsers = match.users.filter(function(e){
				return e.id !== newUser.id;
			}).push(newUser);
			var newItem = item;
			newItem.users = newUsers;
			//Remove match and add back in
			return nList.filter(function(e) {
				return e.id !== newItem.id;
			}).push(newItem);
			
		},
    backgroundUpdate: function backgroundUpdate(user) {
			this.today = this.oldRemover(this.today.slice()),
			this.tomorrow = this.oldRemover(this.tomorrow.slice()),
			this.upcoming = this.oldRemover(this.upcoming.slice())
      $.ajax({
        type: 'GET',
        url: App.homeURL + '/google-calendar/?id=' + user.id,
        success: function (data) {
					var items = data.items;
          items.forEach(function (e, i) {
						var jsDate = new Date(e.date),
								date = Date.getTime();
						if(this.dateEval(date) === "old") {
							return false;
						}
            var item = {
              date: date,
              title: e.title,
              users: [user],
              allDay: e.allDay,
			        id: e.id
            };

            if (item.date.getDate() === today) {
              newToday.push(item);
            }
            if (item.date.getDate() === tomorrow) {
              newTomorrow.push(item);
            }
          }.bind(this));
					var newToday = this.sectionMerge(item,this.today,"today");
          function dateSort(a, b) {
            a = a.date;
            b = b.date;
            return a < b ? -1 : a > b ? 1 : 0;
          };
          var newToday = this.combiner(this.today, newToday);
          var newTomorrow = this.combiner(this.tomorrow, newToday)
          newToday.sort(dateSort);
          newTomorrow.sort(dateSort);
          this.today = newToday;
          this.tomorrow = newTomorrow;
        }.bind(this)

      });
    }
  }
});
</script>
<!--endRemoveIf(script)-->
<div class="module calendar">
  <div class="today">
		<h2>Today</h2>
    <div class="nothing-to-do" v-if="today.length < 1">
      <div class="icon">
        <?php echo file_get_contents(get_template_directory().'/assets/fonts/icon_couch.svg');?>
      </div>
      There's nothing going on today!
    </div>
		<dateitem v-for="item in today" :item="item" />
  </div>
  <div class="tomorrow-container" v-if="tomorrow.length > 0">
		<h2 class="tomorrow">Tomorrow</h2>
		<dateitem v-for="item in tomorrow" :item="item" :dateClass="tomorrow"/>
  </div>
	<div class="upcoming-container" v-if="upcoming.length > 0">
		<h2 class="tomorrow">Tomorrow</h2>
		<dateitem v-for="item in upcoming" :item="item" :dateClass="tomorrow"/>
  </div>
	
</div>
